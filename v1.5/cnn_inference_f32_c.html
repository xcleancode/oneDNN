<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>oneDNN: CNN f32 inference example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML,dnnl"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">oneAPI Deep Neural Network Library (oneDNN)
   &#160;<span id="projectnumber">1.5.0</span>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">CNN f32 inference example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This C API example demonstrates how to build an AlexNet neural network topology for forward-pass inference.</p>
<p>Some key take-aways include:</p>
<ul>
<li>How tensors are implemented and submitted to primitives.</li>
<li>How primitives are created.</li>
<li>How primitives are sequentially submitted to the network, where the output from primitives is passed as input to the next primitive. The latter specifies a dependency between the primitive input and output data.</li>
<li>Specific 'inference-only' configurations.</li>
<li>Limiting the number of reorders performed that are detrimental to performance.</li>
</ul>
<p>The example implements the AlexNet layers as numbered primitives (for example, conv1, pool1, conv2).</p>
<div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div><div class="line"><span class="comment">* Copyright 2016-2020 Intel Corporation</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div><div class="line"><span class="comment">* you may not use this file except in compliance with the License.</span></div><div class="line"><span class="comment">* You may obtain a copy of the License at</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">*     http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Unless required by applicable law or agreed to in writing, software</span></div><div class="line"><span class="comment">* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div><div class="line"><span class="comment">* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div><div class="line"><span class="comment">* See the License for the specific language governing permissions and</span></div><div class="line"><span class="comment">* limitations under the License.</span></div><div class="line"><span class="comment">*******************************************************************************/</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Required for posix_memalign</span></div><div class="line"><span class="preprocessor">#define _POSIX_C_SOURCE 200112L</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dnnl_8h.html">dnnl.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;example_utils.h&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define BATCH 8</span></div><div class="line"><span class="preprocessor">#define IC 3</span></div><div class="line"><span class="preprocessor">#define OC 96</span></div><div class="line"><span class="preprocessor">#define CONV_IH 227</span></div><div class="line"><span class="preprocessor">#define CONV_IW 227</span></div><div class="line"><span class="preprocessor">#define CONV_OH 55</span></div><div class="line"><span class="preprocessor">#define CONV_OW 55</span></div><div class="line"><span class="preprocessor">#define CONV_STRIDE 4</span></div><div class="line"><span class="preprocessor">#define CONV_PAD 0</span></div><div class="line"><span class="preprocessor">#define POOL_OH 27</span></div><div class="line"><span class="preprocessor">#define POOL_OW 27</span></div><div class="line"><span class="preprocessor">#define POOL_STRIDE 2</span></div><div class="line"><span class="preprocessor">#define POOL_PAD 0</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> product(<a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> *arr, <span class="keywordtype">size_t</span> size) {</div><div class="line">    <span class="keywordtype">size_t</span> prod = 1;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; ++i)</div><div class="line">        prod *= arr[i];</div><div class="line">    <span class="keywordflow">return</span> prod;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> init_net_data(<span class="keywordtype">float</span> *data, uint32_t dim, <span class="keyword">const</span> <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> *dims) {</div><div class="line">    <span class="keywordflow">if</span> (dim == 1) {</div><div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> i = 0; i &lt; dims[0]; ++i) {</div><div class="line">            data[i] = (float)(i % 1637);</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dim == 4) {</div><div class="line">        <span class="keywordflow">for</span> (<a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> in = 0; in &lt; dims[0]; ++in)</div><div class="line">            <span class="keywordflow">for</span> (<a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> ic = 0; ic &lt; dims[1]; ++ic)</div><div class="line">                <span class="keywordflow">for</span> (<a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> ih = 0; ih &lt; dims[2]; ++ih)</div><div class="line">                    <span class="keywordflow">for</span> (<a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> iw = 0; iw &lt; dims[3]; ++iw) {</div><div class="line">                        <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> indx = in * dims[1] * dims[2] * dims[3]</div><div class="line">                                + ic * dims[2] * dims[3] + ih * dims[3] + iw;</div><div class="line">                        data[indx] = (float)(indx % 1637);</div><div class="line">                    }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    <span class="keywordtype">int</span> nargs;</div><div class="line">    <a class="code" href="structdnnl__exec__arg__t.html">dnnl_exec_arg_t</a> *args;</div><div class="line">} args_t;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> prepare_arg_node(args_t *node, <span class="keywordtype">int</span> nargs) {</div><div class="line">    node-&gt;args = (<a class="code" href="structdnnl__exec__arg__t.html">dnnl_exec_arg_t</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structdnnl__exec__arg__t.html">dnnl_exec_arg_t</a>) * nargs);</div><div class="line">    node-&gt;nargs = nargs;</div><div class="line">}</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> free_arg_node(args_t *node) {</div><div class="line">    free(node-&gt;args);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> set_arg(<a class="code" href="structdnnl__exec__arg__t.html">dnnl_exec_arg_t</a> *arg, <span class="keywordtype">int</span> arg_idx, <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> memory) {</div><div class="line">    arg-&gt;<a class="code" href="structdnnl__exec__arg__t.html#a46c7f77870713b8af3fd37dc66e9690b">arg</a> = arg_idx;</div><div class="line">    arg-&gt;<a class="code" href="structdnnl__exec__arg__t.html#a048f23e80b923636267c4dece912cd0d">memory</a> = memory;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> init_data_memory(uint32_t dim, <span class="keyword">const</span> <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> *dims,</div><div class="line">        <a class="code" href="group__dnnl__api__memory.html#ga395e42b594683adb25ed2d842bb3091d">dnnl_format_tag_t</a> user_tag, <a class="code" href="structdnnl__engine.html">dnnl_engine_t</a> engine, <span class="keywordtype">float</span> *data,</div><div class="line">        <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> *memory) {</div><div class="line">    <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> user_md;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#gaff696e368aeefb3036a0419c508dc6be">dnnl_memory_desc_init_by_tag</a>(</div><div class="line">            &amp;user_md, dim, dims, <a class="code" href="group__dnnl__api__memory.html#gga012ba1c84ff24bdd068f9d2f9b26a130a6b33889946b183311c39cc1bd0656ae9">dnnl_f32</a>, user_tag));</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#ga52a9246bd7f4e498b08d61e75e689a0c">dnnl_memory_create</a>(memory, &amp;user_md, engine, DNNL_MEMORY_ALLOCATE));</div><div class="line">    write_to_dnnl_memory(data, *memory);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group__dnnl__api__utils.html#gad24f9ded06e34d3ee71e7fc4b408d57a">dnnl_status_t</a> prepare_reorder(<a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> *user_memory, <span class="comment">// in</span></div><div class="line">        <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *prim_memory_md, <span class="comment">// in</span></div><div class="line">        <a class="code" href="structdnnl__engine.html">dnnl_engine_t</a> prim_engine, <span class="comment">// in: primitive&#39;s engine</span></div><div class="line">        <span class="keywordtype">int</span> dir_is_user_to_prim, <span class="comment">// in: user -&gt; prim or prim -&gt; user</span></div><div class="line">        <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> *prim_memory, <span class="comment">// out: primitive&#39;s memory created</span></div><div class="line">        <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> *reorder, <span class="comment">// out: reorder primitive created</span></div><div class="line">        uint32_t *net_index, <span class="comment">// primitive index in net (inc if reorder created)</span></div><div class="line">        <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> *net, args_t *net_args) { <span class="comment">// net params</span></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *user_memory_md;</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga59a447af4c51aba057856c7b596351d4">dnnl_memory_get_memory_desc</a>(*user_memory, &amp;user_memory_md);</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__engine.html">dnnl_engine_t</a> user_mem_engine;</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga583a4a06428de7d6c4251313e57ad814">dnnl_memory_get_engine</a>(*user_memory, &amp;user_mem_engine);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="group__dnnl__api__memory.html#gaa734e01591b567ed6378df1f404058e2">dnnl_memory_desc_equal</a>(user_memory_md, prim_memory_md)) {</div><div class="line">        CHECK(<a class="code" href="group__dnnl__api__memory.html#ga52a9246bd7f4e498b08d61e75e689a0c">dnnl_memory_create</a>(prim_memory, prim_memory_md, prim_engine,</div><div class="line">                DNNL_MEMORY_ALLOCATE));</div><div class="line"></div><div class="line">        <a class="code" href="structdnnl__primitive__desc.html">dnnl_primitive_desc_t</a> reorder_pd;</div><div class="line">        <span class="keywordflow">if</span> (dir_is_user_to_prim) {</div><div class="line">            CHECK(<a class="code" href="group__dnnl__api__reorder.html#ga099efa7b8fd12ae8de0e3e98fd0ae3ec">dnnl_reorder_primitive_desc_create</a>(&amp;reorder_pd,</div><div class="line">                    user_memory_md, user_mem_engine, prim_memory_md,</div><div class="line">                    prim_engine, NULL));</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            CHECK(<a class="code" href="group__dnnl__api__reorder.html#ga099efa7b8fd12ae8de0e3e98fd0ae3ec">dnnl_reorder_primitive_desc_create</a>(&amp;reorder_pd,</div><div class="line">                    prim_memory_md, prim_engine, user_memory_md,</div><div class="line">                    user_mem_engine, NULL));</div><div class="line">        }</div><div class="line">        CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#gad07540a0074d9cd3a6970b49897e57d3">dnnl_primitive_create</a>(reorder, reorder_pd));</div><div class="line">        CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga643938c7c73d200ac1fd3866204e7285">dnnl_primitive_desc_destroy</a>(reorder_pd));</div><div class="line"></div><div class="line">        net[*net_index] = *reorder;</div><div class="line">        prepare_arg_node(&amp;net_args[*net_index], 2);</div><div class="line">        set_arg(&amp;net_args[*net_index].args[0], <a class="code" href="group__dnnl__api__primitives__common.html#ga953b34f004a8222b04e21851487c611a">DNNL_ARG_FROM</a>,</div><div class="line">                dir_is_user_to_prim ? *user_memory : *prim_memory);</div><div class="line">        set_arg(&amp;net_args[*net_index].args[1], <a class="code" href="group__dnnl__api__primitives__common.html#gaf700c3396987b450413c8df5d78bafd9">DNNL_ARG_TO</a>,</div><div class="line">                dir_is_user_to_prim ? *prim_memory : *user_memory);</div><div class="line">        (*net_index)++;</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        *prim_memory = NULL;</div><div class="line">        *reorder = NULL;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__dnnl__api__utils.html#ggad24f9ded06e34d3ee71e7fc4b408d57aaa31395e9dccc103cf166cf7b38fc5b9c">dnnl_success</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> simple_net(<a class="code" href="group__dnnl__api__engine.html#ga04b3dd9eba628ea02218a52c4c4363a2">dnnl_engine_kind_t</a> engine_kind) {</div><div class="line">    <a class="code" href="structdnnl__engine.html">dnnl_engine_t</a> <a class="code" href="group__dnnl__api__primitives__common.html#gga94efdd650364f4d9776cfb9b711cbdc1aad1943a9fd6d3d7ee1e6af41a5b0d3e7">engine</a>;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__engine.html#gab84f82f3011349cbfe368b61882834fd">dnnl_engine_create</a>(&amp;engine, engine_kind, 0));</div><div class="line"></div><div class="line">    <span class="comment">// build a simple net</span></div><div class="line">    uint32_t n = 0;</div><div class="line">    <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> net[10];</div><div class="line">    args_t net_args[10];</div><div class="line"></div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> net_src_sizes[4] = {BATCH, IC, CONV_IH, CONV_IW};</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> net_dst_sizes[4] = {BATCH, OC, POOL_OH, POOL_OW};</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> *net_src = (<span class="keywordtype">float</span> *)malloc(product(net_src_sizes, 4) * <span class="keyword">sizeof</span>(float));</div><div class="line">    <span class="keywordtype">float</span> *net_dst = (<span class="keywordtype">float</span> *)malloc(product(net_dst_sizes, 4) * <span class="keyword">sizeof</span>(float));</div><div class="line"></div><div class="line">    init_net_data(net_src, 4, net_src_sizes);</div><div class="line">    memset(net_dst, 0, product(net_dst_sizes, 4) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div><div class="line"></div><div class="line">    <span class="comment">// AlexNet: conv</span></div><div class="line">    <span class="comment">// {BATCH, IC, CONV_IH, CONV_IW} (x) {OC, IC, 11, 11} -&gt;</span></div><div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW}</span></div><div class="line">    <span class="comment">// strides: {CONV_STRIDE, CONV_STRIDE}</span></div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> *conv_user_src_sizes = net_src_sizes;</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> conv_user_weights_sizes[4] = {OC, IC, 11, 11};</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> conv_bias_sizes[4] = {OC};</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> conv_user_dst_sizes[4] = {BATCH, OC, CONV_OH, CONV_OW};</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> conv_strides[2] = {CONV_STRIDE, CONV_STRIDE};</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> conv_padding[2] = {CONV_PAD, CONV_PAD};</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> *conv_src = net_src;</div><div class="line">    <span class="keywordtype">float</span> *conv_weights = (<span class="keywordtype">float</span> *)malloc(</div><div class="line">            product(conv_user_weights_sizes, 4) * <span class="keyword">sizeof</span>(float));</div><div class="line">    <span class="keywordtype">float</span> *conv_bias</div><div class="line">            = (<span class="keywordtype">float</span> *)malloc(product(conv_bias_sizes, 1) * <span class="keyword">sizeof</span>(float));</div><div class="line"></div><div class="line">    init_net_data(conv_weights, 4, conv_user_weights_sizes);</div><div class="line">    init_net_data(conv_bias, 1, conv_bias_sizes);</div><div class="line"></div><div class="line">    <span class="comment">// create memory for user data</span></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> conv_user_src_memory, conv_user_weights_memory,</div><div class="line">            conv_user_bias_memory;</div><div class="line">    init_data_memory(4, conv_user_src_sizes, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da83a751aedeb59613312339d0f8b90f54">dnnl_nchw</a>, engine, conv_src,</div><div class="line">            &amp;conv_user_src_memory);</div><div class="line">    init_data_memory(4, conv_user_weights_sizes, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da11176ff202375dcd0d06e2fba5f8a8e0">dnnl_oihw</a>, engine,</div><div class="line">            conv_weights, &amp;conv_user_weights_memory);</div><div class="line">    init_data_memory(1, conv_bias_sizes, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da9ccb37bb1a788f0245efbffbaf81e145">dnnl_x</a>, engine, conv_bias,</div><div class="line">            &amp;conv_user_bias_memory);</div><div class="line"></div><div class="line">    <span class="comment">// create data descriptors for convolution w/ no specified format</span></div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> conv_src_md, conv_weights_md, conv_bias_md, conv_dst_md;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#gaff696e368aeefb3036a0419c508dc6be">dnnl_memory_desc_init_by_tag</a>(&amp;conv_src_md, 4, conv_user_src_sizes,</div><div class="line">            <a class="code" href="group__dnnl__api__memory.html#gga012ba1c84ff24bdd068f9d2f9b26a130a6b33889946b183311c39cc1bd0656ae9">dnnl_f32</a>, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac">dnnl_format_tag_any</a>));</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#gaff696e368aeefb3036a0419c508dc6be">dnnl_memory_desc_init_by_tag</a>(&amp;conv_weights_md, 4,</div><div class="line">            conv_user_weights_sizes, <a class="code" href="group__dnnl__api__memory.html#gga012ba1c84ff24bdd068f9d2f9b26a130a6b33889946b183311c39cc1bd0656ae9">dnnl_f32</a>, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac">dnnl_format_tag_any</a>));</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#gaff696e368aeefb3036a0419c508dc6be">dnnl_memory_desc_init_by_tag</a>(</div><div class="line">            &amp;conv_bias_md, 1, conv_bias_sizes, <a class="code" href="group__dnnl__api__memory.html#gga012ba1c84ff24bdd068f9d2f9b26a130a6b33889946b183311c39cc1bd0656ae9">dnnl_f32</a>, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da9ccb37bb1a788f0245efbffbaf81e145">dnnl_x</a>));</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#gaff696e368aeefb3036a0419c508dc6be">dnnl_memory_desc_init_by_tag</a>(&amp;conv_dst_md, 4, conv_user_dst_sizes,</div><div class="line">            <a class="code" href="group__dnnl__api__memory.html#gga012ba1c84ff24bdd068f9d2f9b26a130a6b33889946b183311c39cc1bd0656ae9">dnnl_f32</a>, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac">dnnl_format_tag_any</a>));</div><div class="line"></div><div class="line">    <span class="comment">// create a convolution</span></div><div class="line">    <a class="code" href="structdnnl__convolution__desc__t.html">dnnl_convolution_desc_t</a> conv_any_desc;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__convolution.html#ga9699a81a0e3341014447e4da0cdd7e18">dnnl_convolution_forward_desc_init</a>(&amp;conv_any_desc, <a class="code" href="group__dnnl__api__primitives__common.html#ggae3c1f22ae55645782923fbfd8b07d0c4a6a59d07a8414bb69b3cb9904ed302adb">dnnl_forward</a>,</div><div class="line">            <a class="code" href="group__dnnl__api__primitives__common.html#gga96946c805f6c4922c38c37049ab95d23a8258635c519746dbf543ac13054acb5a">dnnl_convolution_direct</a>, &amp;conv_src_md, &amp;conv_weights_md,</div><div class="line">            &amp;conv_bias_md, &amp;conv_dst_md, conv_strides, conv_padding,</div><div class="line">            conv_padding));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__primitive__desc.html">dnnl_primitive_desc_t</a> conv_pd;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga336dd467c36d8fe0d3311ddc73f239cb">dnnl_primitive_desc_create</a>(</div><div class="line">            &amp;conv_pd, &amp;conv_any_desc, NULL, engine, NULL));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> conv_internal_src_memory, conv_internal_weights_memory,</div><div class="line">            conv_internal_dst_memory;</div><div class="line"></div><div class="line">    <span class="comment">// create memory for dst data, we don&#39;t need reorder it to user data</span></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *<a class="code" href="group__dnnl__api__primitives__common.html#gga94efdd650364f4d9776cfb9b711cbdc1a701158248eed4e5fc84610f2f6026493">dst_md</a></div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(conv_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059add5c338ad7ae0c296509e54d22130598">dnnl_query_dst_md</a>, 0);</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#ga52a9246bd7f4e498b08d61e75e689a0c">dnnl_memory_create</a>(</div><div class="line">            &amp;conv_internal_dst_memory, dst_md, engine, DNNL_MEMORY_ALLOCATE));</div><div class="line"></div><div class="line">    <span class="comment">// create reorder primitives between user data and convolution srcs</span></div><div class="line">    <span class="comment">// if required</span></div><div class="line">    <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> conv_reorder_src, conv_reorder_weights;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *<a class="code" href="group__dnnl__api__primitives__common.html#gga94efdd650364f4d9776cfb9b711cbdc1a90a729e395453e1d9411ad416c796819">src_md</a></div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(conv_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059a14a86faee7b85eeb60d0d7886756ffa5">dnnl_query_src_md</a>, 0);</div><div class="line">    CHECK(prepare_reorder(&amp;conv_user_src_memory, src_md, engine, 1,</div><div class="line">            &amp;conv_internal_src_memory, &amp;conv_reorder_src, &amp;n, net, net_args));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *<a class="code" href="group__dnnl__api__primitives__common.html#gga94efdd650364f4d9776cfb9b711cbdc1a06ba7b00a8c95dcf3a90e16d00eeb0e9">weights_md</a></div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(conv_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059a12ea0b4858b84889acab34e498323355">dnnl_query_weights_md</a>, 0);</div><div class="line">    CHECK(prepare_reorder(&amp;conv_user_weights_memory, weights_md, engine, 1,</div><div class="line">            &amp;conv_internal_weights_memory, &amp;conv_reorder_weights, &amp;n, net,</div><div class="line">            net_args));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> conv_src_memory = conv_internal_src_memory</div><div class="line">            ? conv_internal_src_memory</div><div class="line">            : conv_user_src_memory;</div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> conv_weights_memory = conv_internal_weights_memory</div><div class="line">            ? conv_internal_weights_memory</div><div class="line">            : conv_user_weights_memory;</div><div class="line"></div><div class="line">    <span class="comment">// finally create a convolution primitive</span></div><div class="line">    <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> conv;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#gad07540a0074d9cd3a6970b49897e57d3">dnnl_primitive_create</a>(&amp;conv, conv_pd));</div><div class="line">    net[n] = conv;</div><div class="line">    prepare_arg_node(&amp;net_args[n], 4);</div><div class="line">    set_arg(&amp;net_args[n].args[0], <a class="code" href="group__dnnl__api__primitives__common.html#gac37ad67b48edeb9e742af0e50b70fe09">DNNL_ARG_SRC</a>, conv_src_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[1], <a class="code" href="group__dnnl__api__primitives__common.html#gaf279f28c59a807e71a70c719db56c5b3">DNNL_ARG_WEIGHTS</a>, conv_weights_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[2], <a class="code" href="group__dnnl__api__primitives__common.html#gad0cbc09942aba93fbe3c0c2e09166f0d">DNNL_ARG_BIAS</a>, conv_user_bias_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[3], <a class="code" href="group__dnnl__api__primitives__common.html#ga3ca217e4a06d42a0ede3c018383c388f">DNNL_ARG_DST</a>, conv_internal_dst_memory);</div><div class="line">    n++;</div><div class="line"></div><div class="line">    <span class="comment">// AlexNet: relu</span></div><div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW} -&gt; {BATCH, OC, CONV_OH, CONV_OW}</span></div><div class="line">    <span class="keywordtype">float</span> negative_slope = 1.0f;</div><div class="line"></div><div class="line">    <span class="comment">// create relu memory descriptor on dst memory descriptor</span></div><div class="line">    <span class="comment">// from previous primitive</span></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *relu_src_md</div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(conv_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059add5c338ad7ae0c296509e54d22130598">dnnl_query_dst_md</a>, 0);</div><div class="line"></div><div class="line">    <span class="comment">// create a relu</span></div><div class="line">    <a class="code" href="structdnnl__eltwise__desc__t.html">dnnl_eltwise_desc_t</a> relu_desc;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__eltwise.html#ga5606fd4c9291f7caca8b015460d2f037">dnnl_eltwise_forward_desc_init</a>(&amp;relu_desc, <a class="code" href="group__dnnl__api__primitives__common.html#ggae3c1f22ae55645782923fbfd8b07d0c4a6a59d07a8414bb69b3cb9904ed302adb">dnnl_forward</a>,</div><div class="line">            <a class="code" href="group__dnnl__api__primitives__common.html#gga96946c805f6c4922c38c37049ab95d23a5e37643fec6531331e2e38df68d4c65a">dnnl_eltwise_relu</a>, relu_src_md, negative_slope, 0));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__primitive__desc.html">dnnl_primitive_desc_t</a> relu_pd;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga336dd467c36d8fe0d3311ddc73f239cb">dnnl_primitive_desc_create</a>(&amp;relu_pd, &amp;relu_desc, NULL, engine, NULL));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> relu_dst_memory;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *relu_dst_md</div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(relu_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059add5c338ad7ae0c296509e54d22130598">dnnl_query_dst_md</a>, 0);</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#ga52a9246bd7f4e498b08d61e75e689a0c">dnnl_memory_create</a>(</div><div class="line">            &amp;relu_dst_memory, relu_dst_md, engine, DNNL_MEMORY_ALLOCATE));</div><div class="line"></div><div class="line">    <span class="comment">// finally create a relu primitive</span></div><div class="line">    <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> relu;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#gad07540a0074d9cd3a6970b49897e57d3">dnnl_primitive_create</a>(&amp;relu, relu_pd));</div><div class="line">    net[n] = relu;</div><div class="line">    prepare_arg_node(&amp;net_args[n], 2);</div><div class="line">    set_arg(&amp;net_args[n].args[0], <a class="code" href="group__dnnl__api__primitives__common.html#gac37ad67b48edeb9e742af0e50b70fe09">DNNL_ARG_SRC</a>, conv_internal_dst_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[1], <a class="code" href="group__dnnl__api__primitives__common.html#ga3ca217e4a06d42a0ede3c018383c388f">DNNL_ARG_DST</a>, relu_dst_memory);</div><div class="line">    n++;</div><div class="line"></div><div class="line">    <span class="comment">// AlexNet: lrn</span></div><div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW} -&gt; {BATCH, OC, CONV_OH, CONV_OW}</span></div><div class="line">    <span class="comment">// local size: 5</span></div><div class="line">    <span class="comment">// alpha: 0.0001</span></div><div class="line">    <span class="comment">// beta: 0.75</span></div><div class="line">    <span class="comment">// k: 1.0</span></div><div class="line">    uint32_t local_size = 5;</div><div class="line">    <span class="keywordtype">float</span> alpha = 0.0001f;</div><div class="line">    <span class="keywordtype">float</span> beta = 0.75f;</div><div class="line">    <span class="keywordtype">float</span> k = 1.0f;</div><div class="line"></div><div class="line">    <span class="comment">// create lrn src memory descriptor using dst memory descriptor</span></div><div class="line">    <span class="comment">//  from previous primitive</span></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *lrn_src_md = relu_dst_md;</div><div class="line"></div><div class="line">    <span class="comment">// create a lrn primitive descriptor</span></div><div class="line">    <a class="code" href="structdnnl__lrn__desc__t.html">dnnl_lrn_desc_t</a> lrn_desc;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__lrn.html#gae124b34228f8c5adffc7733bccbf5658">dnnl_lrn_forward_desc_init</a>(&amp;lrn_desc, <a class="code" href="group__dnnl__api__primitives__common.html#ggae3c1f22ae55645782923fbfd8b07d0c4a6a59d07a8414bb69b3cb9904ed302adb">dnnl_forward</a>,</div><div class="line">            <a class="code" href="group__dnnl__api__primitives__common.html#gga96946c805f6c4922c38c37049ab95d23a540b116253bf1290b9536929198d18fd">dnnl_lrn_across_channels</a>, lrn_src_md, local_size, alpha, beta, k));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__primitive__desc.html">dnnl_primitive_desc_t</a> lrn_pd;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga336dd467c36d8fe0d3311ddc73f239cb">dnnl_primitive_desc_create</a>(&amp;lrn_pd, &amp;lrn_desc, NULL, engine, NULL));</div><div class="line"></div><div class="line">    <span class="comment">// create primitives for lrn dst and workspace memory</span></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> lrn_dst_memory;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *lrn_dst_md</div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(lrn_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059add5c338ad7ae0c296509e54d22130598">dnnl_query_dst_md</a>, 0);</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#ga52a9246bd7f4e498b08d61e75e689a0c">dnnl_memory_create</a>(</div><div class="line">            &amp;lrn_dst_memory, lrn_dst_md, engine, DNNL_MEMORY_ALLOCATE));</div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> lrn_ws_memory;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *lrn_ws_md</div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(lrn_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059a1c465006660aabe46e644e6df7d36e8a">dnnl_query_workspace_md</a>, 0);</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#ga52a9246bd7f4e498b08d61e75e689a0c">dnnl_memory_create</a>(</div><div class="line">            &amp;lrn_ws_memory, lrn_ws_md, engine, DNNL_MEMORY_ALLOCATE));</div><div class="line"></div><div class="line">    <span class="comment">// finally create a lrn primitive</span></div><div class="line">    <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> lrn;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#gad07540a0074d9cd3a6970b49897e57d3">dnnl_primitive_create</a>(&amp;lrn, lrn_pd));</div><div class="line">    net[n] = lrn;</div><div class="line">    prepare_arg_node(&amp;net_args[n], 3);</div><div class="line">    set_arg(&amp;net_args[n].args[0], <a class="code" href="group__dnnl__api__primitives__common.html#gac37ad67b48edeb9e742af0e50b70fe09">DNNL_ARG_SRC</a>, relu_dst_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[1], <a class="code" href="group__dnnl__api__primitives__common.html#ga3ca217e4a06d42a0ede3c018383c388f">DNNL_ARG_DST</a>, lrn_dst_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[2], <a class="code" href="group__dnnl__api__primitives__common.html#ga550c80e1b9ba4f541202a7ac98be117f">DNNL_ARG_WORKSPACE</a>, lrn_ws_memory);</div><div class="line">    n++;</div><div class="line"></div><div class="line">    <span class="comment">// AlexNet: pool</span></div><div class="line">    <span class="comment">// {BATCH, OC, CONV_OH, CONV_OW} -&gt; {BATCH, OC, POOL_OH, POOL_OW}</span></div><div class="line">    <span class="comment">// kernel: {3, 3}</span></div><div class="line">    <span class="comment">// strides: {POOL_STRIDE, POOL_STRIDE}</span></div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> *pool_dst_sizes = net_dst_sizes;</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> pool_kernel[2] = {3, 3};</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> pool_strides[2] = {POOL_STRIDE, POOL_STRIDE};</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#ga872631b12a112bf43fba985cba24dd20">dnnl_dim_t</a> pool_padding[2] = {POOL_PAD, POOL_PAD};</div><div class="line"></div><div class="line">    <span class="comment">// create pooling memory descriptor on dst descriptor</span></div><div class="line">    <span class="comment">//  from previous primitive</span></div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *pool_src_md = lrn_dst_md;</div><div class="line"></div><div class="line">    <span class="comment">// create descriptors for dst pooling data</span></div><div class="line">    <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> pool_dst_any_md;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#gaff696e368aeefb3036a0419c508dc6be">dnnl_memory_desc_init_by_tag</a>(&amp;pool_dst_any_md, 4, pool_dst_sizes,</div><div class="line">            <a class="code" href="group__dnnl__api__memory.html#gga012ba1c84ff24bdd068f9d2f9b26a130a6b33889946b183311c39cc1bd0656ae9">dnnl_f32</a>, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac">dnnl_format_tag_any</a>));</div><div class="line"></div><div class="line">    <span class="comment">// create memory for user data</span></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> pool_user_dst_memory;</div><div class="line">    init_data_memory(4, pool_dst_sizes, <a class="code" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da83a751aedeb59613312339d0f8b90f54">dnnl_nchw</a>, engine, net_dst,</div><div class="line">            &amp;pool_user_dst_memory);</div><div class="line"></div><div class="line">    <span class="comment">// create a pooling</span></div><div class="line">    <a class="code" href="structdnnl__pooling__desc__t.html">dnnl_pooling_desc_t</a> pool_desc;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__pooling.html#ga1e5b3f2b9088ba7260c996d96268e84e">dnnl_pooling_forward_desc_init</a>(&amp;pool_desc, <a class="code" href="group__dnnl__api__primitives__common.html#ggae3c1f22ae55645782923fbfd8b07d0c4a6a59d07a8414bb69b3cb9904ed302adb">dnnl_forward</a>,</div><div class="line">            <a class="code" href="group__dnnl__api__primitives__common.html#gga96946c805f6c4922c38c37049ab95d23acf3529ba1c4761c0da90eb6750def6c7">dnnl_pooling_max</a>, pool_src_md, &amp;pool_dst_any_md, pool_strides,</div><div class="line">            pool_kernel, pool_padding, pool_padding));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__primitive__desc.html">dnnl_primitive_desc_t</a> pool_pd;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga336dd467c36d8fe0d3311ddc73f239cb">dnnl_primitive_desc_create</a>(&amp;pool_pd, &amp;pool_desc, NULL, engine, NULL));</div><div class="line"></div><div class="line">    <span class="comment">// create memory for workspace</span></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> pool_ws_memory;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *pool_ws_md</div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(pool_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059a1c465006660aabe46e644e6df7d36e8a">dnnl_query_workspace_md</a>, 0);</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__memory.html#ga52a9246bd7f4e498b08d61e75e689a0c">dnnl_memory_create</a>(</div><div class="line">            &amp;pool_ws_memory, pool_ws_md, engine, DNNL_MEMORY_ALLOCATE));</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> pool_dst_memory;</div><div class="line"></div><div class="line">    <span class="comment">// create reorder primitives between user data and pooling dsts</span></div><div class="line">    <span class="comment">// if required</span></div><div class="line">    <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> pool_reorder_dst;</div><div class="line">    <a class="code" href="structdnnl__memory.html">dnnl_memory_t</a> pool_internal_dst_memory;</div><div class="line">    <span class="keyword">const</span> <a class="code" href="structdnnl__memory__desc__t.html">dnnl_memory_desc_t</a> *pool_dst_md</div><div class="line">            = <a class="code" href="group__dnnl__api__primitives__common.html#ga416464a8b3e898d8965a5f3c49d4cd54">dnnl_primitive_desc_query_md</a>(pool_pd, <a class="code" href="group__dnnl__api__primitives__common.html#gga9e5235563cf7cfc10fa89f415de98059add5c338ad7ae0c296509e54d22130598">dnnl_query_dst_md</a>, 0);</div><div class="line">    n += 1; <span class="comment">// tentative workaround: preserve space for pooling that should</span></div><div class="line">            <span class="comment">// happen before the reorder</span></div><div class="line">    CHECK(prepare_reorder(&amp;pool_user_dst_memory, pool_dst_md, engine, 0,</div><div class="line">            &amp;pool_internal_dst_memory, &amp;pool_reorder_dst, &amp;n, net, net_args));</div><div class="line">    n -= pool_reorder_dst ? 2 : 1;</div><div class="line"></div><div class="line">    pool_dst_memory = pool_internal_dst_memory ? pool_internal_dst_memory</div><div class="line">                                               : pool_user_dst_memory;</div><div class="line"></div><div class="line">    <span class="comment">// finally create a pooling primitive</span></div><div class="line">    <a class="code" href="structdnnl__primitive.html">dnnl_primitive_t</a> pool;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#gad07540a0074d9cd3a6970b49897e57d3">dnnl_primitive_create</a>(&amp;pool, pool_pd));</div><div class="line">    net[n] = pool;</div><div class="line">    prepare_arg_node(&amp;net_args[n], 3);</div><div class="line">    set_arg(&amp;net_args[n].args[0], <a class="code" href="group__dnnl__api__primitives__common.html#gac37ad67b48edeb9e742af0e50b70fe09">DNNL_ARG_SRC</a>, lrn_dst_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[1], <a class="code" href="group__dnnl__api__primitives__common.html#ga3ca217e4a06d42a0ede3c018383c388f">DNNL_ARG_DST</a>, pool_dst_memory);</div><div class="line">    set_arg(&amp;net_args[n].args[2], <a class="code" href="group__dnnl__api__primitives__common.html#ga550c80e1b9ba4f541202a7ac98be117f">DNNL_ARG_WORKSPACE</a>, pool_ws_memory);</div><div class="line">    n++;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (pool_reorder_dst) n += 1;</div><div class="line"></div><div class="line">    <a class="code" href="structdnnl__stream.html">dnnl_stream_t</a> stream;</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__stream.html#gaefca700bdec59b22c05f248df5bb3354">dnnl_stream_create</a>(&amp;stream, engine, <a class="code" href="group__dnnl__api__stream.html#gga3d74cfed8fe92b0e4498a1f2bdab5547acf05c543bccebd58e6d4e0db7137fb92">dnnl_stream_default_flags</a>));</div><div class="line">    <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; n; ++i) {</div><div class="line">        CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga57f8ec3a6e5b33a1068cf2236028935c">dnnl_primitive_execute</a>(</div><div class="line">                net[i], stream, net_args[i].nargs, net_args[i].args));</div><div class="line">    }</div><div class="line"></div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__stream.html#ga6a8175b9384349b1ee73a78a24b5883f">dnnl_stream_wait</a>(stream));</div><div class="line"></div><div class="line">    <span class="comment">// clean-up</span></div><div class="line">    <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; n; ++i)</div><div class="line">        free_arg_node(&amp;net_args[i]);</div><div class="line"></div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga643938c7c73d200ac1fd3866204e7285">dnnl_primitive_desc_destroy</a>(conv_pd));</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga643938c7c73d200ac1fd3866204e7285">dnnl_primitive_desc_destroy</a>(relu_pd));</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga643938c7c73d200ac1fd3866204e7285">dnnl_primitive_desc_destroy</a>(lrn_pd));</div><div class="line">    CHECK(<a class="code" href="group__dnnl__api__primitives__common.html#ga643938c7c73d200ac1fd3866204e7285">dnnl_primitive_desc_destroy</a>(pool_pd));</div><div class="line"></div><div class="line">    <a class="code" href="group__dnnl__api__stream.html#gae7fe8b23136cafa62a39301799cd6e44">dnnl_stream_destroy</a>(stream);</div><div class="line"></div><div class="line">    free(net_src);</div><div class="line">    free(net_dst);</div><div class="line"></div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(conv_user_src_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(conv_user_weights_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(conv_user_bias_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(conv_internal_src_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(conv_internal_weights_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(conv_internal_dst_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__primitives__common.html#gaba605c4591c2054a6ee80ec1b581659f">dnnl_primitive_destroy</a>(conv_reorder_src);</div><div class="line">    <a class="code" href="group__dnnl__api__primitives__common.html#gaba605c4591c2054a6ee80ec1b581659f">dnnl_primitive_destroy</a>(conv_reorder_weights);</div><div class="line">    <a class="code" href="group__dnnl__api__primitives__common.html#gaba605c4591c2054a6ee80ec1b581659f">dnnl_primitive_destroy</a>(conv);</div><div class="line"></div><div class="line">    free(conv_weights);</div><div class="line">    free(conv_bias);</div><div class="line"></div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(relu_dst_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__primitives__common.html#gaba605c4591c2054a6ee80ec1b581659f">dnnl_primitive_destroy</a>(relu);</div><div class="line"></div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(lrn_ws_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(lrn_dst_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__primitives__common.html#gaba605c4591c2054a6ee80ec1b581659f">dnnl_primitive_destroy</a>(lrn);</div><div class="line"></div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(pool_user_dst_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(pool_internal_dst_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__memory.html#gaa219225aae8e53489caab3fe1bc80a52">dnnl_memory_destroy</a>(pool_ws_memory);</div><div class="line">    <a class="code" href="group__dnnl__api__primitives__common.html#gaba605c4591c2054a6ee80ec1b581659f">dnnl_primitive_destroy</a>(pool_reorder_dst);</div><div class="line">    <a class="code" href="group__dnnl__api__primitives__common.html#gaba605c4591c2054a6ee80ec1b581659f">dnnl_primitive_destroy</a>(pool);</div><div class="line"></div><div class="line">    <a class="code" href="group__dnnl__api__engine.html#ga8d6976b3792cf1ef64d01545929b4d8f">dnnl_engine_destroy</a>(engine);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div><div class="line">    <a class="code" href="group__dnnl__api__engine.html#ga04b3dd9eba628ea02218a52c4c4363a2">dnnl_engine_kind_t</a> engine_kind = parse_engine_kind(argc, argv);</div><div class="line">    simple_net(engine_kind);</div><div class="line">    printf(<span class="stringliteral">&quot;Example passed on %s.\n&quot;</span>, engine_kind2str_upper(engine_kind));</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<div class="footer">
    <div class="footer-wrapper">
        <ul id="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>