<!-- HTML header for doxygen 1.8.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>oneDNN: Pooling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script src="assets/mathjax/MathJax.js?config=TeX-AMS_CHTML,dnnl"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="assets/customdoxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="assets/dnn.js"></script>
</head>
<body>
<div class="mobile-nav"><i id="nav-btn"></i><a href="index.html">oneAPI Deep Neural Network Library (oneDNN)</a></div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
   <div id="projectname">
     <a href="index.html">
      <div id="full-name">oneAPI Deep Neural Network Library (oneDNN)</div>
    </a>
   </div>
   <div id="projectbrief">Performance library for Deep Learning</div>
   <div id="projectnumber">2.0.0</div>
  <div>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dev_guide_pooling.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Pooling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><blockquote class="doxtable">
<p></p>
<p><a class="el" href="group__dnnl__api__pooling.html">API Reference</a></p>
<p></p>
</blockquote>
<h2>General</h2>
<p>The pooling primitive performs forward or backward max or average pooling operation on 1D, 2D, or 3D spatial data.</p>
<h3>Forward</h3>
<p>The pooling operation is defined by the following formulas. We show formulas only for 2D spatial data which are straightforward to generalize to cases of higher and lower dimensions. Variable names follow the standard <a class="el" href="dev_guide_conventions.html">Naming Conventions</a>.</p>
<p>Max pooling:</p>
<p class="formulaDsp">
\[ \dst(n, c, oh, ow) = \max\limits_{kh, kw} \left( \src(n, c, oh \cdot SH + kh \cdot (DH + 1) - PH_L, ow \cdot SW + kw \cdot (DW + 1) - PW_L) \right) \]
</p>
<p>Average pooling:</p>
<p class="formulaDsp">
\[ \dst(n, c, oh, ow) = \frac{1}{DENOM} \sum\limits_{kh, kw} \src(n, c, oh \cdot SH + kh \cdot (DH + 1) - PH_L, ow \cdot SW + kw \cdot (DW + 1) - PW_L) \]
</p>
<p>Here output spatial dimensions are calculated similarly to how they are done in <a class="el" href="dev_guide_convolution.html">Convolution</a>.</p>
<p>Average pooling supports two algorithms:</p><ul>
<li><a class="el" href="group__dnnl__api__primitives__common.html#gga96946c805f6c4922c38c37049ab95d23ac13a4cc7c0dc1edfcbf1bac23391d5cb" title="Average pooling include padding. ">dnnl_pooling_avg_include_padding</a>, in which case \(DENOM = KH \cdot KW\),</li>
<li><a class="el" href="group__dnnl__api__primitives__common.html#gga96946c805f6c4922c38c37049ab95d23a00156580493fd7c2f4cdbaaf9fcbde79" title="Average pooling exclude padding. ">dnnl_pooling_avg_exclude_padding</a>, in which case \(DENOM\) equals to the size of overlap between an averaging window and images.</li>
</ul>
<blockquote class="doxtable">
<p>TODO: a picture would be nice here. </p>
</blockquote>
<h4>Difference Between Forward Training and Forward Inference</h4>
<ul>
<li>Max pooling requires a <code>workspace</code> for the <a class="el" href="group__dnnl__api__primitives__common.html#ggae3c1f22ae55645782923fbfd8b07d0c4a992e03bebfe623ac876b3636333bbce0" title="Forward data propagation (training mode). ">dnnl_forward_training</a> propagation kind, and does not require it for <a class="el" href="group__dnnl__api__primitives__common.html#ggae3c1f22ae55645782923fbfd8b07d0c4a2f77a568a675dec649eb0450c997856d" title="Forward data propagation (inference mode). ">dnnl_forward_inference</a> (see details below).</li>
</ul>
<h3>Backward</h3>
<p>The backward propagation computes \(\diffsrc(n, c, h, w)\), based on \(\diffdst(n, c, h, w)\) and (in case of max pooling) <code>workspace</code>.</p>
<h2>Execution Arguments</h2>
<p>When executed, the inputs and outputs should be mapped to an execution argument index as specified by the following table.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Primitive input/output  </th><th class="markdownTableHeadNone">Execution argument index   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\(\src\)  </td><td class="markdownTableBodyNone">DNNL_ARG_SRC   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">\(\dst\)  </td><td class="markdownTableBodyNone">DNNL_ARG_DST   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">workspace  </td><td class="markdownTableBodyNone">DNNL_ARG_WORKSPACE   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">\(\diffsrc\)  </td><td class="markdownTableBodyNone">DNNL_ARG_DIFF_SRC   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\(\diffdst\)  </td><td class="markdownTableBodyNone">DNNL_ARG_DIFF_DST   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">\(binary post-op\)  </td><td class="markdownTableBodyNone"><a class="el" href="group__dnnl__api__primitives__common.html#ga30839136bbf81b03a173e0842ae015e1" title="Arguments for a binary post operation. ">DNNL_ARG_ATTR_MULTIPLE_POST_OP(binary_post_op_position)</a> | DNNL_ARG_SRC_1   </td></tr>
</table>
<h2>Implementation Details</h2>
<h3>General Notes</h3>
<ol type="1">
<li>During training, max pooling requires a workspace on forward (<a class="el" href="group__dnnl__api__primitives__common.html#ggae3c1f22ae55645782923fbfd8b07d0c4a992e03bebfe623ac876b3636333bbce0" title="Forward data propagation (training mode). ">dnnl_forward_training</a>) and backward passes to save indices where a maximum was found. The workspace format is opaque, and the indices cannot be restored from it. However, one can use backward pooling to perform up-sampling (used in some detection topologies). The workspace can be created via <code>workspace_desc()</code> from the pooling primitive descriptor.</li>
<li>A user can use memory format tag <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac" title="Undefined memory format tag. ">dnnl_format_tag_any</a> for <code>dst</code> memory descriptor when creating pooling forward propagation. The library would derive the appropriate format from the <code>src</code> memory descriptor. However, the <code>src</code> itself must be defined. Similarly, a user can use memory format tag <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dafee39ac6fff0325cae43cd66495c18ac" title="Undefined memory format tag. ">dnnl_format_tag_any</a> for the <code>diff_src</code> memory descriptor when creating pooling backward propagation.</li>
</ol>
<h3>Data Type Support</h3>
<p>The pooling primitive supports the following combinations of data types:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Propagation  </th><th class="markdownTableHeadLeft">Source / Destination  </th><th class="markdownTableHeadLeft">Acc   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">forward / backward  </td><td class="markdownTableBodyLeft">f32, bf16  </td><td class="markdownTableBodyLeft">f32   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">forward  </td><td class="markdownTableBodyLeft">f16  </td><td class="markdownTableBodyLeft">f16   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">forward  </td><td class="markdownTableBodyLeft">s8, u8, s32  </td><td class="markdownTableBodyLeft">s32   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">forward inference  </td><td class="markdownTableBodyLeft">s8, u8 / f32  </td><td class="markdownTableBodyLeft">f32   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">forward inference  </td><td class="markdownTableBodyLeft">f32 / s8, u8  </td><td class="markdownTableBodyLeft">f32   </td></tr>
</table>
<dl class="section warning"><dt>Warning</dt><dd>There might be hardware and/or implementation specific restrictions. Check <a class="el" href="dev_guide_pooling.html#dg_pool_impl_limits">Implementation Limitations</a> section below.</dd></dl>
<h3>Data Representation</h3>
<h4>Source, Destination, and Their Gradients</h4>
<p>Like other CNN primitives, the pooling primitive expects data to be an \(N \times C \times W\) tensor for the 1D spatial case, an \(N \times C \times H \times W\) tensor for the 2D spatial case, and an \(N \times C \times D \times H \times W\) tensor for the 3D spatial case.</p>
<p>The pooling primitive is optimized for the following memory formats:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Spatial  </th><th class="markdownTableHeadLeft">Logical tensor  </th><th class="markdownTableHeadLeft">Data type  </th><th class="markdownTableHeadLeft">Implementations optimized for memory formats   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">1D  </td><td class="markdownTableBodyLeft">NCW  </td><td class="markdownTableBodyLeft">f32  </td><td class="markdownTableBodyLeft"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dab55cb1d54480dd7f796bf66eea3ad32f" title="3D CNN activations tensor, an alias to dnnl_abc ">dnnl_ncw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dadff5ea69392d7e4da23179dc0ba7cbc2" title="plain 3D tensor ">dnnl_abc</a>), <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da9f756dbdc1e949646c95f83e0f51bc43" title="3D CNN activations tensor, an alias to dnnl_acb ">dnnl_nwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091daf8537ed269eb5d0586456db114039c00" title="permuted 3D tensor ">dnnl_acb</a>), <em>optimized^</em>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">1D  </td><td class="markdownTableBodyLeft">NCW  </td><td class="markdownTableBodyLeft">s32, s8, u8  </td><td class="markdownTableBodyLeft"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da9f756dbdc1e949646c95f83e0f51bc43" title="3D CNN activations tensor, an alias to dnnl_acb ">dnnl_nwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091daf8537ed269eb5d0586456db114039c00" title="permuted 3D tensor ">dnnl_acb</a>), <em>optimized^</em>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">2D  </td><td class="markdownTableBodyLeft">NCHW  </td><td class="markdownTableBodyLeft">f32  </td><td class="markdownTableBodyLeft"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da83a751aedeb59613312339d0f8b90f54" title="4D CNN activations tensor, an alias to dnnl_abcd ">dnnl_nchw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da6e669cc61278663a5ddbd3d0b25c6c5c" title="plain 4D tensor ">dnnl_abcd</a>), <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae50c534446b3c18cc018b3946b3cebd7" title="4D CNN activations tensor, an alias to dnnl_acdb ">dnnl_nhwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da8fcce5dd7260b5b0740e3b37b1e9ad41" title="permuted 4D tensor ">dnnl_acdb</a>), <em>optimized^</em>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">2D  </td><td class="markdownTableBodyLeft">NCHW  </td><td class="markdownTableBodyLeft">s32, s8, u8  </td><td class="markdownTableBodyLeft"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae50c534446b3c18cc018b3946b3cebd7" title="4D CNN activations tensor, an alias to dnnl_acdb ">dnnl_nhwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da8fcce5dd7260b5b0740e3b37b1e9ad41" title="permuted 4D tensor ">dnnl_acdb</a>), <em>optimized^</em>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">3D  </td><td class="markdownTableBodyLeft">NCDHW  </td><td class="markdownTableBodyLeft">f32  </td><td class="markdownTableBodyLeft"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091dae33b8c6790e5d37324f18a019658d464" title="5D CNN activations tensor, an alias to dnnl_abcde ">dnnl_ncdhw</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da30d5d3c9de2931f06d265af81787ada3" title="plain 5D tensor ">dnnl_abcde</a>), <a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091daa0d8b24eefd029e214080d3787114fc2" title="5D CNN activations tensor, an alias to dnnl_acdeb ">dnnl_ndhwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da0cfe86402763786b9b4d73062cfd2f05" title="permuted 5D tensor ">dnnl_acdeb</a>), <em>optimized^</em>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">3D  </td><td class="markdownTableBodyLeft">NCDHW  </td><td class="markdownTableBodyLeft">s32, s8, u8  </td><td class="markdownTableBodyLeft"><a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091daa0d8b24eefd029e214080d3787114fc2" title="5D CNN activations tensor, an alias to dnnl_acdeb ">dnnl_ndhwc</a> (<a class="el" href="group__dnnl__api__memory.html#gga395e42b594683adb25ed2d842bb3091da0cfe86402763786b9b4d73062cfd2f05" title="permuted 5D tensor ">dnnl_acdeb</a>), <em>optimized^</em>   </td></tr>
</table>
<p>Here <em>optimized^</em> means the format that <a class="el" href="memory_format_propagation_cpp.html">comes out</a> of any preceding compute-intensive primitive.</p>
<h3>Post-ops and Attributes</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Propagation  </th><th class="markdownTableHeadLeft">Type  </th><th class="markdownTableHeadLeft">Operation  </th><th class="markdownTableHeadLeft">Description  </th><th class="markdownTableHeadLeft">Restrictions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Forward  </td><td class="markdownTableBodyLeft">Post-op  </td><td class="markdownTableBodyLeft"><a class="el" href="structdnnl_1_1post__ops.html#a40bb2b39a685726ac54873b203be41b5">Binary</a>  </td><td class="markdownTableBodyLeft">Applies a <a class="el" href="group__dnnl__api__binary.html">Binary</a> operation to the result  </td><td class="markdownTableBodyLeft">General binary post-op restrictions   </td></tr>
</table>
<p><a class="anchor" id="dg_pool_impl_limits"></a></p><h2>Implementation Limitations</h2>
<ol type="1">
<li>Refer to <a class="el" href="dev_guide_data_types.html">Data Types</a> for limitations related to data types support.</li>
<li><b>CPU</b><ul>
<li>Different data types of source and destination in forward inference are not supported.</li>
</ul>
</li>
</ol>
<h2>Performance Tips</h2>
<p>N/A</p>
<h2>Examples</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Engine  </th><th class="markdownTableHeadLeft">Name  </th><th class="markdownTableHeadLeft">Com   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CPU/GPU  </td><td class="markdownTableBodyLeft"><a class="el" href="pooling_example_cpp.html">Pooling Primitive Example</a>  </td><td class="markdownTableBodyLeft">This C++ API example demonstrates how to create and execute a <a class="el" href="dev_guide_pooling.html">Pooling</a> primitive in forward training propagation mode.   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div class="footer">
    <script>
        $('#top').prependTo($('#side-nav'));
    </script>
    <div class="footer-wrapper">
        <hr>
        <ul class="footer-links">
            <li><a href="legal_information.html">Legal information</a></li>
        </ul>
    </div>
</div>